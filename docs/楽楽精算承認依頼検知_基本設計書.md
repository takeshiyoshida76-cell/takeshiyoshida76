# 基本設計書  
楽楽精算承認依頼メール → Google Chat 通知スクリプト

## 1. 概要

楽楽精算システムから送信される「承認依頼」メールを定期的に監視し、  
未処理のもの（特定のラベルが付いていないもの）のみを抽出し、  
重要な情報を整形してGoogle Chat（Webhook経由）に通知するGoogle Apps Script。

## 2. システム構成図

```mermaid
graph TD
    A[楽楽精算システム] -->|承認依頼メール| B[(Gmail)]
    B --> C[Google Apps Script: notifyRakurakuToChat]
    
    subgraph 設定情報
        D[Script Properties] --> C
    end
    
    C --> E[未処理の承認依頼スレッド]
    C --> F[Google Chat Incoming Webhook]
    C --> G[処理済みラベル付与]
```

## 3. データフロー

```mermaid
flowchart TD
    Start((開始)) --> GetProps[スクリプトプロパティ取得]
    
    GetProps --> Check{設定すべて存在?}
    Check -->|No| Error[エラー終了]
    Check -->|Yes| Label[ラベル確認・作成]
    
    Label --> Search[対象スレッド検索]
    
    Search --> HasThread{スレッド存在?}
    HasThread -->|なし| Finish((終了))
    HasThread -->|あり| LoopStart[スレッド処理開始]
    
    subgraph スレッド処理
        LoopStart --> Already{処理済みラベル済?}
        Already -->|Yes| Next[次へ]
        Already -->|No| Extract[伝票情報抽出]
        
        Extract --> Build[通知メッセージ作成]
        Build --> Send[Chatへ送信]
        
        Send --> Success{成功?}
        Success -->|Yes| Sleep[2秒待機]
        Success -->|No| LogError[エラーログ]
        
        Sleep --> LabelAdd[処理済みラベル付与]
        LogError --> LabelAdd
        
        LabelAdd --> Next
    end
    
    Next --> More{次のスレッド?}
    More -->|Yes| LoopStart
    More -->|No| Finish
```

## 4. スクリプトプロパティ定義

| キー名          | 説明                                      | 必須 | 例値例                                      |
|-----------------|-------------------------------------------|------|---------------------------------------------|
| WEBHOOK_URL     | Google Chat Incoming Webhook URL          | 必須 | https://chat.googleapis.com/v1/spaces/...   |
| RAKURAKU_FROM   | 楽楽精算の送信元メールアドレス            | 必須 | info@rakuraku-seisan.jp                     |
| LABEL_NAME      | 処理済み判定用Gmailラベル名               | 必須 | 楽楽精算_処理済                             |

**設定方法**  
Google Apps Script エディタ → 左メニュー「プロジェクトの設定」→「スクリプト プロパティ」  
またはスクリプト内で一度だけ以下を実行：

```javascript
PropertiesService.getScriptProperties().setProperties({
  WEBHOOK_URL: "https://chat.googleapis.com/v1/...",
  RAKURAKU_FROM: "info@rakuraku-seisan.jp",
  LABEL_NAME: "楽楽精算_処理済"
});
```

## 5. 主な検索条件

```
from:{RAKURAKU_FROM} "承認依頼" -label:{LABEL_NAME} older_than:2m
```

- `older_than:2m` → 2ヶ月以上前のものは除外（負荷軽減目的。状況に応じて1mや3mなどに変更可）

## 6. 留意点・今後の改善候補

- スレッド内複数メッセージの扱い（現在は全部見るが最新のみでよい可能性も）
- 1通に複数伝票が含まれる場合の対応強化
- エラー発生時の管理者通知（メール送信など）
- 通知フォーマットの改善（表形式、リンク埋め込みなど）
