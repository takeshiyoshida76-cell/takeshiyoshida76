## 勤怠実績チェック自動化システム 基本設計書

---

## 1. 概要

### 1.1. システム名称

Akashi勤怠実績チェック自動化システム (Google Apps Script)

### 1.2. 目的

勤怠管理システム**AKASHI**から社員の月次勤務実績データを自動で取得し、あらかじめ定義された勤怠ルール（打刻漏れ、理由記載漏れ、休憩時間不足、超過勤務時の理由・指示者記載漏れなど）に違反がないかをチェックする。違反事項を**Google Chat**へ通知することで、管理者のチェック業務の負担軽減と、勤怠実績の早期是正を促進する。

### 1.3. 対象範囲

| 項目 | 内容 |
| :--- | :--- |
| **対象システム** | AKASHI（管理者ページ） |
| **実行環境** | Google Apps Script (GAS) |
| **通知先** | Google Chat (Webhook) |
| **対象データ** | 対象社員の指定された年月の勤務実績データ |
| **実行タイミング** | 毎日実行を推奨（22日以降は翌月の勤怠実績をチェック） |
| **対応労働制** | フレックスタイム制、ノーマル労働制 |

---

## 2. システム構成

### 2.1. 構成図（Mermaid）

システムと外部サービスとの連携を以下の図に示します。

```mermaid
graph TD
A["GASスクリプト"] -->|"1. ログインリクエスト"| B["AKASHIサーバー"]
B -->|"2. 認証CookieとCSRFトークン"| A
A -->|"3. 勤怠実績XHRリクエスト"| B
B -->|"4. 勤怠データ(JS/HTML)"| A
A -->|"5. データ解析・チェック"| C{"勤怠ルールチェックロジック"}
C -->|"6. 違反データ抽出"| A
A -->|"7. 指摘事項を通知"| D["Google Chat"]
```

### 2.2. 登場人物関連図（Mermaid）

本スクリプトの実行と通知に関わる関係者を以下の図に示します。

```mermaid
mindmap
  root(("勤怠実績チェック自動化システム"))
    "従業員ID設定"
    "認証情報設定"
    "実行トリガー設定"
    "GAS実行主体"
      "AKASHI"
        "ログイン認証情報提供"
        "勤怠実績データ提供"
      "Google Chat"
        "チェック結果通知"
      "管理者"
        "GASスクリプトプロパティ設定"
        "Chat通知内容確認"
        "社員への是正指示"
      "対象社員"
        "勤怠実績データ提供"
        "Chat通知に基づき是正対応"
```

---

## 3. 機能設計
### 3.1. 主要機能一覧

| No.| 機能名| 概要|
| :--- | :--- | :--- |
| 3.1.1| 認証情報取得機能| スクリプトプロパティからAKASHIログイン情報を取得する。|
| 3.1.2| AKASHIログイン機能| 認証情報とCSRFトークンを用いてAKASHIにログインし、セッションCookieを維持する。|
| 3.1.3| 対象年月決定機能| 実行日（JST）が22日以降の場合、チェック対象を翌月とする。|
| 3.1.4| 勤怠実績取得機能| 対象従業員ID、対象年月に基づき、管理者ページから月次の勤怠実績データをXHRで取得する。|
| 3.1.5| データ解析機能| 取得したHTML/JSデータから、日付、打刻/実績時間、休憩、残業、ステータス、理由欄のテキストなどを抽出する。|
| 3.1.6| 勤怠ルールチェック機能| 抽出した実績データに基づき、定義されたルールに違反がないかチェックする。|
| 3.1.7| 通知機能| 違反事項がある場合、社員ごとに集約し、Google Chatの指定されたWebhook URLに通知する。|

### 3.2. 勤怠ルールチェック詳細

スクリプトで実装されている主な勤怠ルールチェック項目と内容を以下に示します。

| No. | チェック内容 | 判定条件 | 通知メッセージ例 |
| :--- | :--- | :--- | :--- |
| 1 | **打刻忘れ/理由記載漏れ** | 打刻がないが実績時間がある **かつ** 理由欄にキーワード（理由, ため, 為など）がない。 | 打刻忘れがあるが理由が記載されていない可能性あり |
| 2 | **遅刻/早退の理由漏れ** | 勤務状況に「遅刻」「早退」が含まれる **かつ** 理由欄にキーワードがない。 | 遅刻しているが理由欄に遅刻理由が記載されていない可能性あり |
| 3 | **休憩時間不足** | 実働時間 **> 6**時間 **かつ** 休憩時間 **< 45**分、または 実働時間 **> 8**時間 **かつ** 休憩時間 **< 60**分。 | 実働6時間超で休憩45分未満 / 実働8時間超で休憩1時間未満 |
| 4 | **残業/指示者記載漏れ** | 残業時間 **> 0**分 **かつ** 理由欄にキーワード **または**「指示」がない。（フレックスで60分以内は除外） | 残業があるが理由または指示者が記載されていない |
| 5 | **計画外の早退理由漏れ** | 退勤打刻 **<** 退勤予定時間 **かつ** 理由欄にキーワードがない。 | 退勤予定前に打刻されているが理由が記載されていない可能性あり |
| 6 | **打刻と実績の乖離** | 出勤打刻と実績時間の差が **30**分 **かつ** 理由欄にキーワードがない。 | 出勤打刻と実績が30分以上乖離しているが、理由が記載されていない可能性あり |
| 7 | **在宅勤務/出社矛盾** | 理由欄に「在宅勤務」とある **かつ** 勤務状況に「在宅勤務」がない **かつ** 理由欄に「出社」関連語がない。 | 理由欄に在宅勤務とあるが勤務状況に未記載... |
| 8 | **半休と残業の矛盾** | 勤務状況に「午前半年休」または「午後半年休」が含まれる **かつ** 残業時間 **> 0**分。 | 半日休暇にもかかわらず残業が入力されている |
| 9 | **電車遅延の矛盾** | 勤務状況に「電車遅延」がある **かつ** 実績出勤時間 **=** 予定出勤時間、または 勤務状況に「遅刻」が含まれる。 | 電車遅延理由があるが実績出勤時間が予定と同一となっている |
| 10 | **振替出勤/休日の理由漏れ** | 勤務状況に「振替出勤」「休日出勤」が含まれる **かつ** 理由欄にキーワード **または**「指示」がない。 | 休日出勤にもかかわらず、休出理由または指示者が記載されていない |

---

## 4. データ設計
### 4.1. 勤怠データ構造

GASスクリプト内で解析・利用される日ごとの勤怠データ構造 (Object) は以下の通りです。

| 項目名| 型| 説明|
| :--- | :--- | :--- |
| dateStr |string |日付 (yyyymmdd)|
| clockIn, clockOut| string| 打刻時刻 (hh:mm)|
| actualIn, actualOut| string| 実績時刻 (hh:mm)|
| plannedIn, plannedOut| string| 予定時刻 (hh:mm)|
| status| string| 勤務状況（例: 遅刻/在宅勤務/年休など）|
| totalTime| string| 実労働時間 (h:mm)|
| breakTime| string| 休憩時間 (h:mm)|
| overtime| string| 残業時間 (h:mm)|
| nightTime| string| 深夜時間 (h:mm)|
| lateTime| string| 遅刻/早退時間 (h:mm)|
| reason| string| 理由欄に記載されたテキスト|

### 4.2. 設定データ (スクリプトプロパティ)

本システム実行に必須の外部設定情報です。

| プロパティ名| 用途| 必須/任意|
| :--- | :--- | :--- |
| COMPANY_ID| AKASHIログイン用の企業ID| 必須|
| LOGIN_ID| AKASHIログイン用の管理者ログインID| 必須|
| PASSWORD| AKASHIログイン用のパスワード| 必須|
| CHAT_WEBHOOK_URL| Google Chatへの通知用Webhook URL| 必須|

---

## 5. 実行環境・設定

### 5.1. 実行環境

* **プラットフォーム**: Google Apps Script (GAS)
* **言語**: JavaScript (ES5/6 相当)
* **外部サービス**: UrlFetchApp, PropertiesService, Utilities

### 5.2. 初期設定手順

1. **GASのデプロイ**: 提供されたスクリプトをGASエディタにコピー＆ペーストします。
2. **定数設定**: スクリプト内の`TARGET_EMPLOYEE_IDS`に対象従業員IDの配列を設定します。
3. **スクリプトプロパティ設定**: GASエディタのプロジェクト設定またはスクリプトプロパティ画面から、以下の4つのプロパティを設定します。
    * `COMPANY_ID`
    * `LOGIN_ID`
    * `PASSWORD`
    * `CHAT_WEBHOOK_URL`
4. **トリガー設定**: 毎日決まった時間（例: 業務時間終了後）に`main`関数が実行されるよう、時間ベースのトリガーを設定します。

---

## 6. 運用・保守

### 6.1. ログ管理

* GASの実行ログ (`Logger.log`) を使用し、ログイン成否、エラー発生時の詳細情報、処理の進捗を記録します。
* エラー発生時やログイン失敗時は、Google Chatにも通知されます。

### 6.2. メンテナンス

* AKASHIのHTML構造やログインフロー、APIエンドポイントが変更された場合、スクリプトの改修が必要となります。
* 勤怠ルールに変更があった場合は、`checkMonthlyAttendance`関数内のチェックロジックを更新します。

### 6.3. セキュリティ

* AKASHIの認証情報は、スクリプト本体ではなく**スクリプトプロパティ**に安全に保存されます。
* AKASHIへのリクエストは、遅延 (`addRandomDelay`) を挿入し、サーバーへの過負荷やスクレイピングと見なされるリスクを軽減しています。
* 機密情報（パスワードなど）はログに出力されません。

---

## 7. お問い合わせ先

本スクリプトに関するお問い合わせ、機能追加・変更のご要望は、以下までご連絡ください。

* **担当:** 業務推進部.葭田
* **連絡先チャットID:** @moc_01440
* **連絡先メールアドレス:** t_yoshida@mocweb.co.jp

---
