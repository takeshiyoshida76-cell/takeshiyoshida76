# Akashi勤怠チェック自動化スクリプト 基本設計書

## 1. 概要

本スクリプトは、Google Apps Script (GAS) を実行環境とし、Webスクレイピング技術を用いてクラウド勤怠管理システム「Akashi」から従業員の当日の勤怠情報を取得します。取得したデータに基づき、出勤・退勤の打刻漏れをチェックし、Google ChatのWebhookを通じて管理者へリアルタイムに通知することを目的とします。

### 実行環境

* **実行環境:** Google Apps Script (GAS)
* **通信:** `UrlFetchApp` を利用した外部通信
* **通知先:** Google Chat Webhook

---

## 2. 認証周りの仕様 (Akashiログイン)

Akashiのログインは、セッション管理とCSRFトークンを伴う一連のブラウザ操作をシミュレーションすることで行います。

### 2.1 認証情報

認証に必要な情報は、GASの**スクリプトプロパティ**に機密情報として設定され、コード内に直接記述することはありません。

| 項目名 | 用途 | 備考 |
| :--- | :--- | :--- |
| `COMPANY_ID` | 企業ID | ログイン時に使用 |
| `LOGIN_ID` | ログインID | ログイン時に使用 |
| `PASSWORD` | パスワード | ログイン時に使用 |
| `WEBHOOK_URL` | Google Chat Webhook URL | 通知送信先 |

### 2.2 ログインシーケンス

1.  **[GET] ログインページアクセス:** `LOGIN_URL` (`/ja/login`) にアクセスし、レスポンスHTMLから**`authenticity_token` (CSRFトークン)**を抽出し、**初期セッションCookie**を保持します。
2.  **[POST] ログインフォーム送信:** 取得したCSRFトークンと認証情報をペイロードとして `POST` します。HTTPヘッダーには、保持しているセッションCookieを設定します。
3.  **セッション確立:** リダイレクトヘッダーから**最終セッションCookie**を取得し、以降のデータ取得リクエストで使用します。
4.  **ページ遷移:** セッション安定のため、勤怠サマリページ (`/daily_summary`) の前に中間ページを `GET` でアクセスします。

---

## 3. 勤怠データ抽出・チェックの仕様

確立されたセッションCookieを使用して「日次勤怠サマリ」ページにアクセスし、打刻漏れの判定を行います。

### 3.1 データ抽出 (Webスクレイピング)

* **対象ページ:** 勤怠サマリURL (`https://atnd.ak4.jp/ja/manager/daily_summary`)。**当日**のデータを取得します。
* **抽出方法:** HTML内の勤怠情報を含む `<tr>` タグを正規表現で抽出し、以下の情報をパースします。

| データ項目 | 抽出元 | 備考 |
| :--- | :--- | :--- |
| **氏名** (`name`) | `<td>` (Index 1) | **名字のみ**を抽出し、通知対象の判定に使用 |
| **実績出勤** (`stampStart`) | `<td>` (Index 2) | `HH:MM` または 未打刻時は `--:--` |
| **実績退勤** (`stampEnd`) | `<td>` (Index 2) | `HH:MM` または 未打刻時は `--:--` |
| **予定出勤** (`scheduledStart`) | `<td>` (Index 4) | `HH:MM` または 未設定時は `--:--` |
| **予定退勤** (`scheduledEnd`) | `<td>` (Index 4) | `HH:MM` または 未設定時は `--:--` |

### 3.2 打刻漏れチェックロジック

チェックは**現在のJST時刻**を基準に行われます。

| チェック項目 | 条件 | 通知トリガー時刻 (現在時刻が基準) | 通知メッセージ |
| :--- | :--- | :--- | :--- |
| **出勤打刻漏れ** | (1) **実績出勤**が `--:--` <br/> (2) **予定出勤**が `--:--` ではない | 予定開始時刻の **5分前 以降** | 「**出勤**打刻が行われていません」 |
| **退勤打刻漏れ** | (1) **実績退勤**が `--:--` <br/> (2) **予定退勤**が `--:--` ではない | 予定終了時刻の **15分後 以降** | 「**退勤**打刻が行われていません」 |

### 3.3 通知対象のフィルタリング

スクリプト内の `TARGET_NAMES` 定数 (名字の配列) を用いて制御します。

* **`TARGET_NAMES` が空:** 全従業員をチェック対象とします。
* **`TARGET_NAMES` に値がある:** リストに含まれる名字の従業員のみをチェック対象とします。

### 3.4 通知処理

打刻漏れが1件以上検出された場合、Google Chat Webhook経由で通知を送信します。通知内容は打刻アラートのヘッダーと、打刻漏れが発生している従業員ごとのメッセージを結合したものです。

---

## 4. 処理フロー

システム全体の処理フローをMermaid形式で示します。

```mermaid
graph TD
    %% 0. 開始
    A[GAS 定期実行トリガー] --> B;

    %% 1. Akashi ログイン処理
    subgraph ログイン処理
        B[Akashiへログイン開始] --> C{GET /login};
        C --> D["CSRFトークンと初期Cookieを取得"];
        D --> E{"POST /login: 認証情報送信"};
        E --> F["最終セッションCookieを確立"];
    end

    %% 2. データ取得
    F --> G["GET /daily_summary: 勤怠サマリHTML取得"];
    G --> H["HTMLを解析し、全従業員データを抽出"];
    H --> I{"打刻漏れアラートリストを初期化"};

    %% 3. チェック処理ループ
    I --> J{"対象従業員リストを走査"};
    J -- 次の従業員へ --> J;

    J -- 従業員をチェック --> K;

    subgraph 打刻漏れチェック
        K{"予定出勤時刻の5分後を過ぎたか？"};
        K -- Yes --> L{"実績出勤打刻(stampStart)はあるか？"};
        K -- No --> J;

        L -- No (漏れ) --> M["出勤アラートを追加"];
        L -- Yes --> N{"予定退勤時刻の15分後を過ぎたか？"};

        M --> N;

        N -- Yes --> O{"実績退勤打刻(stampEnd)はあるか？"};
        N -- No --> J;

        O -- No (漏れ) --> P["退勤アラートを追加"];
        O -- Yes --> J;

        P --> J;
    end

    %% 4. 通知処理
    J -- ループ完了 --> Q{"アラートリストは空か？"};
    Q -- Yes --> R["処理完了(通知なし)"];
    Q -- No --> S["Google Chat Webhookに通知を送信"];
    S --> R;

    %% 5. 終了
    R --> T(End);
```

---

## 5. 非機能要件

| 項目 | 内容 |
| :--- | :--- |
| **信頼性** | GASの組み込みリトライ機能を利用し、一時的なネットワークエラーに対応します。連続した実行失敗時は、通知ログを確認し、手動でスクリプトを停止・再開することを想定します。 |
| **性能** | Akashiへのアクセスは原則として1日数十回（またはトリガー設定頻度）とし、システムへの負荷を最小限に抑えます。GASの実行時間は最長5分以内での完了を目指します。 |
| **セキュリティ** | Akashiの認証情報、およびGoogle ChatのWebhook URLは、すべてGASの**スクリプトプロパティ**に設定し、コード内に直接記述することはしません。GASの実行権限は、スクリプトの所有者に限定されます。 |
| **保守性** | 主要な設定値（ID、パスワード、URL、通知対象者リスト）は、コード上部の定数またはスクリプトプロパティに集約します。 |

---

## 6. エラーハンドリング

| フェーズ | 発生しうるエラー | 対応策 |
| :--- | :--- | :--- |
| **ログイン** | 認証情報間違い、Akashi側のURL変更、メンテナンスなどによるアクセス失敗 | `try-catch` で捕捉し、エラーメッセージをGASのコンソールログに出力して処理を中断・終了します。 |
| **データ取得** | Akashi側のHTML構造変更、ネットワークエラーなど | `try-catch` で捕捉し、エラーメッセージをコンソールログに出力して処理を中断・終了します。 |
| **通知** | Webhook URL間違い、Google Chat側の通信エラーなど | `try-catch` で捕捉し、エラーメッセージをコンソールログに出力します。本処理は通知の送信をもって完了とするため、**処理は継続（終了）** します。 |

---

## 7. 運用・実行スケジュール

| 項目 | 内容 |
| :--- | :--- |
| **トリガー** | GASの**時刻指定型トリガー** (`Time-driven trigger`) を使用します。 |
| **実行頻度** | 30分おき、1時間おきなどに1回実行することを想定します。 |
| **監視** | GASの実行履歴とコンソールログを定期的に確認し、スクリプトの成功/失敗を監視します。 |
